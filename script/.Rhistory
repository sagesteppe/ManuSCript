select(doy, week) %>%
distinct()
flr_date_ranges <- select(flr_date_ranges, -doy)
blst_expert <- blst %>%
select(species, sample.id, TAXON_NEW, Genus, Family, Prcnt_seqs, Prcnt_Seqs_Class) %>%
mutate(RecordID = 1:n()) %>%
left_join(., pollen_sample_info,  by = 'sample.id') %>%
relocate(site:date, .before = TAXON_NEW) %>%
mutate(doy = lubridate::yday(date)) %>%
left_join(., week_tab, by = 'doy') %>%
left_join(., flr_date_ranges, by = c('site', 'Genus', 'week')) %>%
relocate(sample.id, .before = plant.species)
rm(corb, week_tab, flr_date_ranges, pollen_sample_info)
######## SAMPLE 55 SHOULD BE SOMEWHERE HERE.
duplicate_reps_in_sample <- blst_expert %>%
# identify the duplicate samples
drop_na(plant.species) %>%
group_by(RecordID) %>%
distinct(plant.species, .keep_all = T) %>%
group_by(sample.id, TAXON_NEW) %>%
filter(n() >= 2)
dupe_ids <- duplicate_reps_in_sample %>% pull(RecordID) %>% unique()
dupe_samples <- duplicate_reps_in_sample %>% pull(sample.id) %>% unique()
# now split the reads assigned to them into each constituent taxon ~ 'unwise King Solomon'
duplicate_reps_in_sample <- duplicate_reps_in_sample %>%
ungroup() %>%
group_by(sample.id, Genus) %>%
mutate(Prcnt_seqs_Reclass =
ifelse(n() == 2, Prcnt_seqs/2, sum(Prcnt_seqs)/n_distinct(plant.species)/2 ),
TAXON_EXPERT = plant.species) %>%
distinct(sample.id, plant.species, .keep_all = T)
ranunc_splash <- c('Caltha', 'Trollius', 'Thalictrum', 'Aquilegia')
blst_reclass_expert <- blst_expert %>%
filter(!RecordID %in% dupe_ids) %>%
distinct() %>%
rowwise() %>%
mutate(Genus = str_trim(Genus)) %>%
mutate(TAXON_EXPERT = case_when(
sample.id == 3 & Genus == 'Delphinium' ~ plant.species,
sample.id == 4 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 4 ~ plant.species, # 4 has a viola split ; NOW COMPLETE
sample.id == 6 ~ plant.species, # has a delphinium split
# Symphyotrichum foliaceum check on day 173
sample.id == 9 ~ plant.species, # has both Delphinium # Symphyotrichum foliaceum check on day 176
sample.id == 10 ~ plant.species, # has many late season taxa
sample.id == 14 ~ plant.species,  # # Symphyotrichum foliaceum check on day 165
sample.id == 15 ~ plant.species, ## has many mysterious Rosids @ Gothic Spires  - call potentilla?
sample.id == 18 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis', # & Ericaceae
sample.id == 18 ~ plant.species, # Erigeron grandiflorus on day 166 @ Frogs Pond
sample.id == 19 & Genus == 'Nemophila' ~ 'Hydrophyllum.fendleri', # multiple Onagraceae
sample.id == 19 ~ plant.species, #
sample.id == 20 & TAXON_NEW == 'Hydrophyllum canadense' ~ 'Hydrophyllum fendleri',
sample.id == 20 ~ plant.species, # Erigeron grandiflorus doy 165 @ Avery Wash
sample.id == 21 ~ plant.species, # Erigeron grandiflorus & cirsium parryi doy 165 @ Gothic Spires
sample.id == 23 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 23 ~ plant.species, # has both Viola             ## COMPLETE ##
sample.id == 24 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 24 ~ plant.species,                              ## COMPLETE ##
sample.id == 25 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 25 ~ plant.species,                              ## COMPELTE ##
sample.id == 26 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 26 ~ plant.species,                              ## COMPLETE ##
sample.id == 27 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 27 ~ plant.species, # has both Hydrophyllum      ## COMPLETE ##
sample.id == 28 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 28 ~ plant.species,                              ## COMPLETE ##
sample.id == 29 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 30 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Erigeron' ~ 'Erigeron elatior',
sample.id == 32 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 32 ~ plant.species,                              ## COMPLETE ##
sample.id == 33 ~ plant.species, # has both Viola
# Symphyotrichum foliaceum check on day 166
sample.id == 35 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 35 ~ plant.species, # has both Viola             ## COMPLETE ##
sample.id == 36 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 36 ~ plant.species,                              ## COMPLETE ##
sample.id == 39 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 39 ~ plant.species, # has both hydrophyllum      ## COMPLETE ##
sample.id == 40 ~ plant.species,                              ## COMPLETE ##
sample.id == 41 & Genus == 'Cynoglossum' ~ 'Mertensia.ciliata',
sample.id == 41 & Genus == 'Viola' ~ 'Viola adunca',          ## COMPLETE ##
sample.id == 41 ~ plant.species,                              ## COMPLETE ##
sample.id == 42 ~ plant.species,
sample.id == 43 ~ plant.species,                             ## COMPLETE  ##
sample.id == 44 ~ plant.species, # 44 has both delphinium
sample.id == 45 ~ plant.species,         ## EARLY ASTER DAY 163 @ FROGS.POND ##
sample.id == 46 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 46 ~ plant.species,         ## EARLY ASTER DAY 163 @ FROGS.POND ##
sample.id == 49 & Genus %in% ranunc_splash ~ 'Delphinium.barbeyi',
sample.id == 49 & Genus == 'Viola' ~ 'Viola.adunca',
sample.id == 49 ~ plant.species,                              ## COMPLETE ##
sample.id == 51 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 51 ~ plant.species,  ## Helianthella quinquenervis @ DOY 166 ##
sample.id == 52 ~ plant.species,    ## Erigeron elatior  on DOY 163 @ AVERY WASH ##
sample.id == 54 ~ plant.species,                             ## COMPLETE ##
sample.id == 55 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 55 ~ plant.species,                              ## COMPLETE ##
sample.id == 56 & Genus == 'Nemophila' ~ 'Hydrophyllum fendleri',
sample.id == 56 ~ plant.species,          ## DOY 169 FROGS.POND Symphyotrichum foliaceum
## & Erigeron elatior ##
sample.id == 60 & Genus == 'Viola' ~ 'Viola.adunca',
sample.id == 60 ~ plant.species,
sample.id == 65 ~ plant.species, # 65 has a mertensia split
TRUE ~ as.character(TAXON_NEW)
)) %>%
mutate(
TAXON_EXPERT = str_replace_all(TAXON_EXPERT, '[.]', ' '),
TAXON_EXPERT = if_else(is.na(TAXON_EXPERT), TAXON_NEW, TAXON_EXPERT),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Holodiscus argenteus', 'Potentilla pulcherrima'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Scabrethia scabra', 'Wyethia arizonica'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Geum ternatum', 'Geum triflorum'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Erigeron grandiflorus', 'Erigeron elatior'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Agastache pallidiflora', 'Pedicularis'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Lithophragma parviflorum', 'Lithophragma glabrum'),
TAXON_EXPERT = str_replace(TAXON_EXPERT,
'Arenaria globiflora|Minuartia recurva|Sagina procumbens', 'Eremogone congesta'),
TAXON_EXPERT = if_else(doy <= 171 & Genus == 'Cynoglossum',
'Mertensia fusiformis', TAXON_EXPERT),
TAXON_EXPERT = if_else(doy < 190 & TAXON_EXPERT == 'Lupinus argenteus',
'Lupinus sericeus', TAXON_EXPERT))  %>%
# use this to sum up the total sequences by original read record
distinct(sample.id, TAXON_NEW, .keep_all = T) %>%
group_by(sample.id, TAXON_EXPERT) %>%
mutate(Prcnt_seqs_Reclass = sum(Prcnt_seqs)) %>%
# now reduce to the amount of rows of the proper classification
ungroup() %>%
distinct(sample.id, TAXON_EXPERT, .keep_all = T) %>% # what is going on with sample 56 then?
# add back on the multiple groups
bind_rows(., duplicate_reps_in_sample)  %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
# now we split up the reads assigned to conflicted groups  # e.g. Cynoglossum amplifolium in sample 65
b <- blst_reclass_expert %>%
filter(sample.id %in% dupe_samples) %>%
group_by(sample.id, Family) %>%
filter(n() >= 3) %>%
mutate(plant.species = na_if(plant.species, "Thalictrum.fendleri")) %>%
mutate(Seqs2distribute = sum(Prcnt_seqs_Reclass))
records2drop <- b %>% pull(RecordID)
b <- b %>%
drop_na(plant.species) %>%
mutate(Prcnt_seqs_Reclass = Seqs2distribute/n_distinct(TAXON_EXPERT)) %>%
select(-Seqs2distribute)
blst_reclass_expert <- blst_reclass_expert %>%
filter(!RecordID %in% records2drop) %>%
bind_rows(., b) %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
rm(records2drop, b)
s55 <- blst_reclass_expert %>%
filter(sample.id == 55) %>%
group_by(Genus) %>%
mutate(Seqs2distribute = sum(Prcnt_seqs_Reclass)) %>%
filter(TAXON_EXPERT != 'Delphinium gracile') %>%
mutate(Prcnt_seqs_Reclass = Seqs2distribute/n_distinct(TAXON_EXPERT)) %>%
select(-Seqs2distribute)
blst_reclass_expert <- blst_reclass_expert %>%
filter(sample.id != 55) %>%
bind_rows(., s55)  %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
rm(s55)
blst_reclass_expert <- blst_reclass_expert %>%
group_by(sample.id) %>%
mutate(multiplier = 100/ sum(Prcnt_seqs_Reclass),
Prcnt_seqs_Reclass2 = Prcnt_seqs_Reclass * multiplier)
yargh <- split(blst_reclass_expert, f = blst_reclass_expert$sample.id)
View(yargh[["60"]])
View(yargh[["65"]])
View(blst_reclass_expert)
flr_date_ranges <- read.csv(
file.path('../data',  files[grep('flower_ranks', files)] )) %>%
select(site, doy, week, plant.species:abun.rank) %>%
group_by(plant.species, site) %>%
select(site, week, doy, plant.species) %>%
mutate(Genus = str_extract(plant.species, '^.+?(?=[.]|$)')) %>%
mutate(Genus = case_when(
Genus == 'Erythrocoma' ~ 'Geum',
Genus == 'Amerosedum' ~ 'Sedum',
Genus == 'Pentaphylloides' ~ 'Dasiphora',
TRUE ~ Genus
)) %>%
mutate(plant.species = case_when(
plant.species == 'Lathyrus.leucanthus' ~ 'Lathyrus.lanszwertii',
plant.species == 'Lupinus.bakeri' ~ 'Lupinus.sericeus',
TRUE ~ plant.species
)) %>% distinct()
View(flr_date_ranges)
blst_reclass_expert <- blst_expert %>%
filter(!RecordID %in% dupe_ids) %>%
distinct() %>%
rowwise() %>%
mutate(Genus = str_trim(Genus)) %>%
mutate(TAXON_EXPERT = case_when(
sample.id == 3 & Genus == 'Delphinium' ~ plant.species,
sample.id == 4 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 4 ~ plant.species, # 4 has a viola split ; NOW COMPLETE
sample.id == 6 ~ plant.species, # has a delphinium split
# Symphyotrichum foliaceum check on day 173
sample.id == 9 ~ plant.species, # has both Delphinium # Symphyotrichum foliaceum check on day 176
sample.id == 10 ~ plant.species, # has many late season taxa
sample.id == 14 ~ plant.species,  # # Symphyotrichum foliaceum check on day 165
sample.id == 15 ~ plant.species, ## has many mysterious Rosids @ Gothic Spires  - call potentilla?
sample.id == 18 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis', # & Ericaceae
sample.id == 18 ~ plant.species, # Erigeron grandiflorus on day 166 @ Frogs Pond
sample.id == 19 & Genus == 'Nemophila' ~ 'Hydrophyllum.fendleri', # multiple Onagraceae
sample.id == 19 ~ plant.species, #
sample.id == 20 & TAXON_NEW == 'Hydrophyllum canadense' ~ 'Hydrophyllum fendleri',
sample.id == 20 ~ plant.species, # Erigeron grandiflorus doy 165 @ Avery Wash
sample.id == 21 ~ plant.species, # Erigeron grandiflorus & cirsium parryi doy 165 @ Gothic Spires
sample.id == 23 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 23 ~ plant.species, # has both Viola             ## COMPLETE ##
sample.id == 24 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 24 ~ plant.species,                              ## COMPLETE ##
sample.id == 25 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 25 ~ plant.species,                              ## COMPELTE ##
sample.id == 26 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 26 ~ plant.species,                              ## COMPLETE ##
sample.id == 27 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 27 ~ plant.species, # has both Hydrophyllum      ## COMPLETE ##
sample.id == 28 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 28 ~ plant.species,                              ## COMPLETE ##
sample.id == 29 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 30 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Erigeron' ~ 'Erigeron elatior',
sample.id == 32 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 32 ~ plant.species,                              ## COMPLETE ##
sample.id == 33 ~ plant.species, # has both Viola
# Symphyotrichum foliaceum check on day 166
sample.id == 35 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 35 ~ plant.species, # has both Viola             ## COMPLETE ##
sample.id == 36 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 36 ~ plant.species,                              ## COMPLETE ##
sample.id == 39 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 39 ~ plant.species, # has both hydrophyllum      ## COMPLETE ##
sample.id == 40 ~ plant.species,                              ## COMPLETE ##
sample.id == 41 & Genus == 'Cynoglossum' ~ 'Mertensia.ciliata',
sample.id == 41 & Genus == 'Viola' ~ 'Viola adunca',          ## COMPLETE ##
sample.id == 41 ~ plant.species,                              ## COMPLETE ##
sample.id == 42 ~ plant.species,
sample.id == 43 ~ plant.species,                             ## COMPLETE  ##
sample.id == 44 ~ plant.species, # 44 has both delphinium
sample.id == 45 ~ plant.species,         ## EARLY ASTER DAY 163 @ FROGS.POND ##
sample.id == 46 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 46 ~ plant.species,         ## EARLY ASTER DAY 163 @ FROGS.POND ##
sample.id == 49 & Genus %in% ranunc_splash ~ 'Delphinium.barbeyi',
sample.id == 49 & Genus == 'Viola' ~ 'Viola.adunca',
sample.id == 49 ~ plant.species,                              ## COMPLETE ##
sample.id == 51 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 51 ~ plant.species,  ## Helianthella quinquenervis @ DOY 166 ##
sample.id == 52 ~ plant.species,    ## Erigeron elatior  on DOY 163 @ AVERY WASH ##
sample.id == 54 ~ plant.species,                             ## COMPLETE ##
sample.id == 55 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 55 ~ plant.species,                              ## COMPLETE ##
sample.id == 56 & Genus == 'Nemophila' ~ 'Hydrophyllum fendleri',
sample.id == 56 ~ plant.species,          ## DOY 169 FROGS.POND Symphyotrichum foliaceum
## & Erigeron elatior ##
sample.id == 60 & Genus == 'Viola' ~ 'Viola.adunca',          ## COMPLETE ##
sample.id == 60 ~ plant.species,
sample.id == 60 & Genus == 'Viola' ~ 'Viola',
sample.id == 65 ~ plant.species, # 65 has a mertensia split
TRUE ~ as.character(TAXON_NEW)
)) %>%
mutate(
TAXON_EXPERT = str_replace_all(TAXON_EXPERT, '[.]', ' '),
TAXON_EXPERT = if_else(is.na(TAXON_EXPERT), TAXON_NEW, TAXON_EXPERT),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Holodiscus argenteus', 'Potentilla pulcherrima'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Scabrethia scabra', 'Wyethia arizonica'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Geum ternatum', 'Geum triflorum'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Erigeron grandiflorus', 'Erigeron elatior'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Agastache pallidiflora', 'Pedicularis'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Lithophragma parviflorum', 'Lithophragma glabrum'),
TAXON_EXPERT = str_replace(TAXON_EXPERT,
'Arenaria globiflora|Minuartia recurva|Sagina procumbens', 'Eremogone congesta'),
TAXON_EXPERT = if_else(doy <= 171 & Genus == 'Cynoglossum',
'Mertensia fusiformis', TAXON_EXPERT),
TAXON_EXPERT = if_else(doy < 190 & TAXON_EXPERT == 'Lupinus argenteus',
'Lupinus sericeus', TAXON_EXPERT))  %>%
# use this to sum up the total sequences by original read record
distinct(sample.id, TAXON_NEW, .keep_all = T) %>%
group_by(sample.id, TAXON_EXPERT) %>%
mutate(Prcnt_seqs_Reclass = sum(Prcnt_seqs)) %>%
# now reduce to the amount of rows of the proper classification
ungroup() %>%
distinct(sample.id, TAXON_EXPERT, .keep_all = T) %>% # what is going on with sample 56 then?
# add back on the multiple groups
bind_rows(., duplicate_reps_in_sample)  %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
rm(ranunc_splash, blst_expert)
# now we split up the reads assigned to conflicted groups  # e.g. Cynoglossum amplifolium in sample 65
b <- blst_reclass_expert %>%
filter(sample.id %in% dupe_samples) %>%
group_by(sample.id, Family) %>%
filter(n() >= 3) %>%
mutate(plant.species = na_if(plant.species, "Thalictrum.fendleri")) %>%
mutate(Seqs2distribute = sum(Prcnt_seqs_Reclass))
records2drop <- b %>% pull(RecordID)
b <- b %>%
drop_na(plant.species) %>%
mutate(Prcnt_seqs_Reclass = Seqs2distribute/n_distinct(TAXON_EXPERT)) %>%
select(-Seqs2distribute)
blst_reclass_expert <- blst_reclass_expert %>%
filter(!RecordID %in% records2drop) %>%
bind_rows(., b) %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
rm(records2drop, b)
s55 <- blst_reclass_expert %>%
filter(sample.id == 55) %>%
group_by(Genus) %>%
mutate(Seqs2distribute = sum(Prcnt_seqs_Reclass)) %>%
filter(TAXON_EXPERT != 'Delphinium gracile') %>%
mutate(Prcnt_seqs_Reclass = Seqs2distribute/n_distinct(TAXON_EXPERT)) %>%
select(-Seqs2distribute)
blst_reclass_expert <- blst_reclass_expert %>%
filter(sample.id != 55) %>%
bind_rows(., s55)  %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
rm(s55)
blst_reclass_expert <- blst_reclass_expert %>%
group_by(sample.id) %>%
mutate(multiplier = 100/ sum(Prcnt_seqs_Reclass),
Prcnt_seqs_Reclass2 = Prcnt_seqs_Reclass * multiplier)
yargh <- split(blst_reclass_expert, f = blst_reclass_expert$sample.id)
View(yargh[["3"]])
library(tidyverse)
setwd('~/Documents/ManuSCript/script')
pmorpho <- read.csv('../data/morpho_pollen.csv')
blst <- read.csv('../data/blst4experts.csv')
## Load in the microscopy count datasheets to gather information on sample provenance
pollen_sample_info <- readxl::read_xlsx(file.path('../data',
list.files(path = '../data', pattern = 'xlsx') )) %>%
select(site, date, sample.id) %>%
distinct() %>%
filter(!date %in% c('42170', '42169'))
files <- list.files(path = '../data')
## load in the floral observations to provide high resolution spatial and temporal information
flr_date_ranges <- read.csv(
file.path('../data',  files[grep('flower_ranks', files)] )) %>%
select(site, doy, week, plant.species:abun.rank) %>%
group_by(plant.species, site) %>%
select(site, week, doy, plant.species) %>%
mutate(Genus = str_extract(plant.species, '^.+?(?=[.]|$)')) %>%
mutate(Genus = case_when(
Genus == 'Erythrocoma' ~ 'Geum',
Genus == 'Amerosedum' ~ 'Sedum',
Genus == 'Pentaphylloides' ~ 'Dasiphora',
TRUE ~ Genus
)) %>%
mutate(plant.species = case_when(
plant.species == 'Lathyrus.leucanthus' ~ 'Lathyrus.lanszwertii',
plant.species == 'Lupinus.bakeri' ~ 'Lupinus.sericeus',
TRUE ~ plant.species
)) %>% distinct()
## create a look up table to be able to join the known plant locations to
## sequence data by WEEK
week_tab <- flr_date_ranges %>%
ungroup() %>%
select(doy, week) %>%
distinct()
flr_date_ranges <- select(flr_date_ranges, -doy)
## Create a data frame which contains the sample provenance and sequencing data
## information
blst_expert <- blst %>%
select(species, sample.id, TAXON_NEW, Genus, Family, Prcnt_seqs, Prcnt_Seqs_Class) %>%
mutate(RecordID = 1:n()) %>%
left_join(., pollen_sample_info,  by = 'sample.id') %>%
relocate(site:date, .before = TAXON_NEW) %>%
mutate(doy = lubridate::yday(date)) %>%
left_join(., week_tab, by = 'doy') %>%
left_join(., flr_date_ranges, by = c('site', 'Genus', 'week')) %>%
relocate(sample.id, .before = plant.species)
rm(corb, week_tab, flr_date_ranges, pollen_sample_info)
duplicate_reps_in_sample <- blst_expert %>%
# identify the duplicate samples
drop_na(plant.species) %>%
group_by(RecordID) %>%
distinct(plant.species, .keep_all = T) %>%
group_by(sample.id, TAXON_NEW) %>%
filter(n() >= 2)
dupe_ids <- duplicate_reps_in_sample %>% pull(RecordID) %>% unique()
dupe_samples <- duplicate_reps_in_sample %>% pull(sample.id) %>% unique()
# now split the reads assigned to them into each constituent taxon ~ 'unwise King Solomon'
duplicate_reps_in_sample <- duplicate_reps_in_sample %>%
ungroup() %>%
group_by(sample.id, Genus) %>%
mutate(Prcnt_seqs_Reclass =
ifelse(n() == 2, Prcnt_seqs/2, sum(Prcnt_seqs)/n_distinct(plant.species)/2 ),
TAXON_EXPERT = plant.species) %>%
distinct(sample.id, plant.species, .keep_all = T)
## define a list of splash out sequences, note the lsat 2 are not obligates with
## delphinium, and will not always be substituted out!!
ranunc_splash <- c('Caltha', 'Trollius', 'Thalictrum', 'Aquilegia')
# we will now manually reconsider EVERY single sequence classification in
# light of the field based data. AND floral interactions observations
blst_reclass_expert <- blst_expert %>%
filter(!RecordID %in% dupe_ids) %>%
distinct() %>%
rowwise() %>%
mutate(Genus = str_trim(Genus)) %>%
mutate(TAXON_EXPERT = case_when(
sample.id == 3 & Family == 'Asteraceae' ~  'Taraxacum.officinale',
sample.id == 3 & Family %in% c('Rosaceae', 'Onagraceae') ~  'Potentilla.pulcherrima',
sample.id == 3 & Genus == 'Delphinium' ~ plant.species,       ## COMPLETE ##
sample.id == 4 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 4 ~ plant.species,                               ## COMPLETE ##
sample.id == 6 ~ plant.species,                               ## COMPLETE ##
sample.id == 9 & TAXON_NEW == 'Symphyotrichum foliaceum' ~ 'Erigeron speciosus',
sample.id == 9 ~ plant.species,                               ## COMPLETE ##
sample.id == 10 & Family == 'Asteraceae' ~  'Taraxacum.officinale',
#  sample.id == 10 & Family == 'Onagraceae' ~ ''
sample.id == 10 ~ plant.species, # has many late season taxa
sample.id == 14 & Genus == 'Symphyotrichum' ~ 'Senecio.integerrimus',
sample.id == 14 ~ plant.species,                              ## COMPLETE ##
sample.id == 15 & Family %in% c('Onagraceae', 'Rosaceae')  ~ 'Potentilla pulcherrima',
sample.id == 15 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 15 ~ plant.species,                              ## COMPLETE ##
sample.id == 18 & Family == 'Ericaceae' ~ 'Ericaceae', # ONLY TO FAMILY
sample.id == 18 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 18 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 18 ~ plant.species,                              ## COMPLETE ##
sample.id == 19 & Family == 'Onagraceae' ~ 'Epilobium',
sample.id == 19 & Genus == 'Pseudognaphalium' ~ 'Senecio.integerrimus',
sample.id == 19 & Genus == 'Nemophila' ~ 'Hydrophyllum.fendleri',
sample.id == 19 ~ plant.species,                              ## COMPLETE ##
sample.id == 20 & TAXON_NEW == 'Hydrophyllum canadense' ~ 'Hydrophyllum fendleri',
sample.id == 20 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 20 ~ plant.species,                              ## COMPLETE ##
sample.id == 21 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 21 ~ plant.species,                              ## COMPLETE ##
sample.id == 23 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 23 ~ plant.species,                              ## COMPLETE ##
sample.id == 24 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 24 ~ plant.species,                              ## COMPLETE ##
sample.id == 25 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 25 ~ plant.species,                              ## COMPELTE ##
sample.id == 26 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 26 ~ plant.species,                              ## COMPLETE ##
sample.id == 27 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 27 ~ plant.species,                              ## COMPLETE ##
sample.id == 28 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 28 ~ plant.species,                              ## COMPLETE ##
sample.id == 29 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 30 ~ plant.species,                              ## COMPLETE ##
sample.id == 30 & Genus == 'Erigeron' ~ 'Erigeron elatior',
sample.id == 32 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 32 ~ plant.species,                              ## COMPLETE ##
sample.id == 33 ~ plant.species, # Symphyotrichum foliaceum check on day 166
sample.id == 35 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 35 ~ plant.species,                              ## COMPLETE ##
sample.id == 36 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 36 ~ plant.species,                              ## COMPLETE ##
sample.id == 39 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 39 ~ plant.species,                              ## COMPLETE ##
sample.id == 40 ~ plant.species,                              ## COMPLETE ##
sample.id == 41 & Genus == 'Cynoglossum' ~ 'Mertensia.ciliata',
sample.id == 41 & Genus == 'Viola' ~ 'Viola adunca',          ## COMPLETE ##
sample.id == 41 ~ plant.species,                              ## COMPLETE ##
sample.id == 42 ~ plant.species,
sample.id == 43 & Genus == 'Epilobium' ~ 'Geranium richardsonii',
sample.id == 43 ~ plant.species,                              ## COMPLETE ##
sample.id == 43 & Genus == 'Epilobium' ~ 'Geranium richardsonii',
sample.id == 44 ~ plant.species,
sample.id == 45 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 45 ~ plant.species,                              ## COMPLETE ##
sample.id == 46 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 46 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 46 ~ plant.species,                              ## COMPLETE ##
sample.id == 49 & Genus %in% ranunc_splash ~ 'Delphinium.barbeyi',
sample.id == 49 & Genus == 'Viola' ~ 'Viola.adunca',
sample.id == 49 ~ plant.species,                              ## COMPLETE ##
sample.id == 51 & Genus %in% ranunc_splash ~ 'Delphinium.nuttallianum',
sample.id == 51 ~ plant.species,  ## Helianthella quinquenervis @ DOY 166 ##
sample.id == 52 ~ plant.species,    ## Erigeron elatior  on DOY 163 @ AVERY WASH ##
sample.id == 54 ~ plant.species,                              ## COMPLETE ##
sample.id == 55 & Genus == 'Cynoglossum' ~ 'Mertensia.fusiformis',
sample.id == 55 ~ plant.species,                              ## COMPLETE ##
sample.id == 56 & Genus == 'Nemophila' ~ 'Hydrophyllum fendleri',
sample.id == 56 & Family == 'Asteraceae' ~ 'Senecio.integerrimus',
sample.id == 56 ~ plant.species,                              ## COMPLETE ##
sample.id == 60 & Genus == 'Viola' ~ 'Viola.adunca',          ## COMPLETE ##
sample.id == 60 ~ plant.species,
sample.id == 65 & Genus == 'Viola' ~ 'Viola.praemorsa',       ## COMPLETE ##
sample.id == 65 ~ plant.species,
TRUE ~ as.character(TAXON_NEW)
))  %>%
mutate(
TAXON_EXPERT = str_replace_all(TAXON_EXPERT, '[.]', ' '),
TAXON_EXPERT = if_else(is.na(TAXON_EXPERT), TAXON_NEW, TAXON_EXPERT),
# all of these are unequivocal remaps.
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Holodiscus argenteus', 'Potentilla pulcherrima'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Scabrethia scabra', 'Wyethia arizonica'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Geum ternatum', 'Geum triflorum'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Erigeron grandiflorus', 'Erigeron elatior'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Agastache pallidiflora', 'Pedicularis'),
TAXON_EXPERT = str_replace(TAXON_EXPERT, 'Lithophragma parviflorum', 'Lithophragma glabrum'),
TAXON_EXPERT = str_replace(
TAXON_EXPERT, 'Arenaria globiflora|Minuartia recurva|Sagina procumbens', 'Eremogone congesta'),
TAXON_EXPERT = if_else(doy <= 171 & Genus == 'Cynoglossum',
'Mertensia fusiformis', TAXON_EXPERT),
TAXON_EXPERT = if_else(doy < 190 & TAXON_EXPERT == 'Lupinus argenteus',
'Lupinus sericeus', TAXON_EXPERT))  %>%
# use this to sum up the total sequences by original read record
distinct(sample.id, TAXON_NEW, .keep_all = T) %>%
group_by(sample.id, TAXON_EXPERT) %>%
mutate(Prcnt_seqs_Reclass = sum(Prcnt_seqs)) %>%
# now reduce to the amount of rows of the proper classification
ungroup() %>%
distinct(sample.id, TAXON_EXPERT, .keep_all = T) %>% # what is going on with sample 56 then?
# add back on the multiple groups
bind_rows(., duplicate_reps_in_sample)  %>%
arrange(sample.id, -Prcnt_seqs_Reclass)
